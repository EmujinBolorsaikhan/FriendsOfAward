@page "/home/{Token}"
@rendermode InteractiveServer

@inject IQrCodeService QrCodeService
@inject NavigationManager Nav

@if (_loading)
{
    <p>Lade...</p>
}
else if (!_isValidToken)
{
    <h2>Ungültiger oder bereits verwendeter QR-Code</h2>
}
else
{
    <h1>Diplomarbeiten</h1>

    <div class="legend-box">
        <p>Wählen Sie eine Diplomarbeit aus:</p>
        <p class="small-note">Klicken Sie auf die Schaltflächen, um eine Auswahl zu treffen.</p>
    </div>

    <div id="buttonGrid">
        @for (int i = 0; i < Buttons.Count; i++)
        {
            int cur = i;
            <button class="button @GetCssClass(i)" @onclick="() => OnButtonClick(cur)">
                Diplomarbeit @(i + 1)
            </button>
        }
    </div>

    <div id="info">Weitere Informationen zur Auswahl der Diplomarbeit</div>
    <div id="message">@Message</div>

    <button id="submitBtn"
            @onclick="OnSubmitClick"
            disabled="@(FavoritCount == 0 && SuperIndex == -1)">
        Absenden
    </button>

    <div id="adminToggle" @onclick="ToggleAdmin">⚙️</div>

    <div id="adminPanel" style="display:@(showAdmin ? "block" : "none")">
        <p>Admin-Panel</p>
    </div>

    @if (showConfirmDialog)
    {
        <div class="modal-overlay" @onclick="() => OnConfirmCancel()">
            <div class="confirmation-dialog" @onclick:stopPropagation="true">
                <p>Sie haben nicht alle Ihre Stimmen abgegeben. Möchten Sie ihre Auswahl dennoch absenden?</p>
                <div class="dialog-buttons">
                    <button class="btn-ja" @onclick="OnConfirmYes">Ja</button>
                    <button class="btn-nein" @onclick="OnConfirmNo">Nein</button>
                    <button class="btn-abbrechen" @onclick="OnConfirmCancel">Abbrechen</button>
                </div>
            </div>
        </div>
    }
}

@code {
    // 🔑 Route parameter
    [Parameter]
    public string Token { get; set; } = string.Empty;

    private bool _loading = true;
    private bool _isValidToken = false;

    protected override async Task OnParametersSetAsync()
    {
        _loading = true;

        // Validate token against DB
        _isValidToken = await QrCodeService.TokenExistsAsync(Token);

        if (!_isValidToken)
        {
            // Optional redirect instead of message:
            // Nav.NavigateTo("/not-found", true);
        }

        _loading = false;
    }

    // ===========================
    // EXISTING LOGIC (unchanged)
    // ===========================

    private enum BtnState { Normal, Favorit, Super }
    private List<BtnState> Buttons = Enumerable.Repeat(BtnState.Normal, 20).ToList();

    private string Message = "";
    private bool showAdmin = false;
    private bool showConfirmDialog = false;

    private int FavoritCount => Buttons.Count(b => b == BtnState.Favorit);
    private int SuperIndex => Buttons.FindIndex(b => b == BtnState.Super);

    private void ToggleAdmin() => showAdmin = !showAdmin;

    private void OnButtonClick(int index)
    {
        var state = Buttons[index];

        if (state == BtnState.Normal)
        {
            if (FavoritCount >= 6 || (SuperIndex != -1 && FavoritCount >= 5))
            {
                Message = "Maximal 6 Favoriten erlaubt.";
                return;
            }

            if (FavoritCount == 5 && SuperIndex == -1)
            {
                Buttons[index] = BtnState.Super;
                Message = $"Super-Favorit gewählt: Diplomarbeit {index + 1}";
                return;
            }

            Buttons[index] = BtnState.Favorit;
            Message = $"Favorit gewählt: Diplomarbeit {index + 1}";
            return;
        }

        if (state == BtnState.Favorit)
        {
            if (SuperIndex != -1)
            {
                Buttons[SuperIndex] = BtnState.Favorit;
            }

            Buttons[index] = BtnState.Super;
            Message = $"Super-Favorit gewählt: Diplomarbeit {index + 1}";
            return;
        }

        if (state == BtnState.Super)
        {
            Buttons[index] = BtnState.Normal;
            Message = $"Super-Favorit entfernt: Diplomarbeit {index + 1}";
        }
    }

    private string GetCssClass(int index) =>
        Buttons[index] switch
        {
            BtnState.Favorit => "favorite",
            BtnState.Super => "topfavorite",
            _ => ""
        };

    private void OnSubmitClick()
    {
        if (FavoritCount == 5 && SuperIndex != -1)
            SubmitVotes();
        else
            showConfirmDialog = true;
    }

    private void OnConfirmYes()
    {
        showConfirmDialog = false;
        SubmitVotes();
    }

    private void OnConfirmNo() => showConfirmDialog = false;
    private void OnConfirmCancel() => showConfirmDialog = false;

    private void SubmitVotes()
    {
        // TODO: save votes + mark token as used
        Message = "Stimmen abgesendet!";
    }
}
