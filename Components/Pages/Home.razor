@page "/home/{Token}"
@rendermode InteractiveServer

@inject IQrCodeService QrCodeService
@inject NavigationManager Nav

@if (_loading)
{
    <p>Lade...</p>
}
else if (!_isValidToken)
{
    <h2>Ungültiger oder bereits verwendeter QR-Code</h2>
}
else
{
    <h1>Diplomarbeiten</h1>

    <div class="legend-box">
        <p>Wählen Sie eine Diplomarbeit aus:</p>
        <p class="small-note">Klicken Sie auf die Schaltflächen, um eine Auswahl zu treffen.</p>
    </div>

    <div id="buttonGrid">
        @for (int i = 0; i < Buttons.Count; i++)
        {
            int cur = i;
            <button class="button @GetCssClass(i)" @onclick="() => OnButtonClick(cur)">
                Diplomarbeit @(i + 1)
            </button>
        }
    </div>
    <p class="vote-status">
        Favoriten: @FavoritCount / 5 |
        Super-Favorit: @(SuperIndex != -1 ? "gewählt" : "fehlt")
    </p>

    <div id="info">Weitere Informationen zur Auswahl der Diplomarbeit</div>
    <div id="message">@Message</div>

    <button id="submitBtn"
            @onclick="OnSubmitClick"
            disabled="@(!IsVoteValid)">
        Absenden
    </button>


    <div id="adminToggle" @onclick="ToggleAdmin">⚙️</div>

    <div id="adminPanel" style="display:@(showAdmin ? "block" : "none")">
        <p>Admin-Panel</p>
    </div>

}

@code {
    // Route parameter
    [Parameter]
    public string Token { get; set; } = string.Empty;

    private bool _loading = true;
    private bool _isValidToken = false;
    private bool IsVoteValid => FavoritCount == 5 && SuperIndex != -1;

    protected override async Task OnParametersSetAsync()
    {
        Console.WriteLine($"TOKEN VALUE: {Token}");
        _loading = true;
        // Validate token against DB
        _isValidToken = await QrCodeService.TokenExistsAsync(Token);

        if (!_isValidToken)
        {
            // Optional redirect instead of message:
            // Nav.NavigateTo("/not-found", true);
        }

        _loading = false;
    }


    private enum BtnState { Normal, Favorit, Super }
    private List<BtnState> Buttons = Enumerable.Repeat(BtnState.Normal, 20).ToList();

    private string Message = "";
    private bool showAdmin = false;
    private bool showConfirmDialog = false;
    private bool _submitting = false;

    private int FavoritCount => Buttons.Count(b => b == BtnState.Favorit);
    private int SuperIndex => Buttons.FindIndex(b => b == BtnState.Super);

    private void ToggleAdmin() => showAdmin = !showAdmin;

    private void OnButtonClick(int index)
    {
        var state = Buttons[index];

        if (state == BtnState.Normal)
        {
            if (FavoritCount >= 5 && SuperIndex != -1)
            {
                Message = "Sie haben bereits 5 Favoriten und einen Super-Favoriten gewählt.";
                return;
            }

            if (FavoritCount >= 5 && SuperIndex == -1)
            {
                Buttons[index] = BtnState.Super;
                Message = $"Super-Favorit gewählt: Diplomarbeit {index + 1}";
                return;
            }

            if (FavoritCount == 5 && SuperIndex == -1)
            {
                Buttons[index] = BtnState.Super;
                Message = $"Super-Favorit gewählt: Diplomarbeit {index + 1}";
                return;
            }

            Buttons[index] = BtnState.Favorit;
            Message = $"Favorit gewählt: Diplomarbeit {index + 1}";
            return;
        }

        if (state == BtnState.Favorit)
        {
            if (SuperIndex != -1)
            {
                Buttons[SuperIndex] = BtnState.Favorit;
            }

            Buttons[index] = BtnState.Super;
            Message = $"Super-Favorit gewählt: Diplomarbeit {index + 1}";
            return;
        }

        if (state == BtnState.Super)
        {
            Buttons[index] = BtnState.Normal;
            Message = $"Super-Favorit entfernt: Diplomarbeit {index + 1}";
        }
    }

    private string GetCssClass(int index) =>
        Buttons[index] switch
        {
            BtnState.Favorit => "favorite",
            BtnState.Super => "topfavorite",
            _ => ""
        };

    private async Task OnSubmitClick()
    {
        if (!IsVoteValid)
        {
            Message = "Bitte wählen Sie genau 5 Favoriten und 1 Super-Favorit aus.";
            return;
        }

        await SubmitVotes();
    }

    private async Task SubmitVotes()
    {
        if (_submitting)
            return;

        _submitting = true;

        try
        {
            var favorites = Buttons
                .Select((b, i) => new { b, i })
                .Where(x => x.b == BtnState.Favorit)
                .Select(x => x.i + 1)
                .ToList();

            var super = SuperIndex != -1 ? SuperIndex + 1 : (int?)null;

            var result = await QrCodeService.SubmitVotesAsync(new VoteSubmission
            {
                Token = Token,
                Favorites = favorites,
                SuperFavorite = super
            });

            Message = result
                ? "Stimmen erfolgreich gespeichert!"
                : "Dieser QR-Code wurde bereits verwendet.";

            // OPTIONAL: redirect after vote
            if (result)
                Nav.NavigateTo("/thanks", true);
        }
        finally
        {
            _submitting = false;
        }
    }

}
